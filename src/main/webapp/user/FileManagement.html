<!doctype html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <meta name="description" content="">
    <meta name="author" content="">
    <!--标签页图片-->
    <link rel="icon" type="image/x-icon" href="../icon/faviconX64.ico"/>
    <link rel="canonical" href="https://getbootstrap.com/docs/3.4/examples/dashboard/">

    <title>文件管理</title>

    <!-- Bootstrap core CSS -->
    <link href="../css/bootstrap.min.css" rel="stylesheet">

    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <link href="https://cdn.jsdelivr.net/npm/@bootcss/v3.bootcss.com@1.0.10/assets/css/ie10-viewport-bug-workaround.css"
          rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="https://cdn.jsdelivr.net/npm/@bootcss/v3.bootcss.com@1.0.10/examples/dashboard/dashboard.css"
          rel="stylesheet">

    <!-- Just for debugging purposes. Don't actually copy these 2 lines! -->
    <!--[if lt IE 9]>
    <script src="https://cdn.jsdelivr.net/npm/@bootcss/v3.bootcss.com@1.0.10/assets/js/ie8-responsive-file-warning.js"></script>
    <![endif]-->
    <script src="https://cdn.jsdelivr.net/npm/@bootcss/v3.bootcss.com@1.0.10/assets/js/ie-emulation-modes-warning.js"></script>

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>

<body>
<!--上方导航栏-->
<nav class="navbar navbar-inverse navbar-fixed-top">
    <div class="container-fluid">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar"
                    aria-expanded="false" aria-controls="navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="#">文件管理系统</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
            <ul class="nav navbar-nav navbar-right">
                <li><a href="#" id="username"></a></li>
                <li><a href="../Login/logout">注销</a></li>
            </ul>
        </div>
    </div>
</nav>


<div class="container-fluid">
    <div class="row">
        <!--左侧功能栏-->
        <div class="col-sm-3 col-md-2 sidebar">
            <ul class="nav nav-sidebar">
                <!--被选中的蓝色-->
                <li class="active"><a href="#">文件管理 <span class="sr-only">(current)</span></a></li>
            </ul>
            <ul class="nav nav-sidebar">
                <!--被选中的蓝色-->
                <li><a href="UserManagement.html">用户管理</a></li>
            </ul>
            <!--
            <ul class="nav nav-sidebar">
                <li><a href="">Nav item</a></li>
                <li><a href="">Nav item again</a></li>
                <li><a href="">One more nav</a></li>
                <li><a href="">Another nav item</a></li>
                <li><a href="">More navigation</a></li>
            </ul>
            <ul class="nav nav-sidebar">
                <li><a href="">Nav item again</a></li>
                <li><a href="">One more nav</a></li>
                <li><a href="">Another nav item</a></li>
            </ul>
            -->
        </div>
        <!--右侧主面板-->
        <div class="col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-2 main">
            <h1 class="page-header">文件管理</h1>
            <div class="row">
                <div class="col-md-2">
                    <label for="queryFileId">ID</label>
                    <input id="queryFileId" type="text" class="form-control"
                           placeholder="ID">
                </div>
                <div class="col-md-2">
                    <label for="queryFilename">文件名</label>
                    <input id="queryFilename" type="text" class="form-control"
                           placeholder="文件名">
                </div>
                <div class="col-md-2">
                    <label for="queryUploadUserID">上传者ID</label>
                    <input id="queryUploadUserID" type="text" class="form-control"
                           placeholder="上传者ID">
                </div>
                <div class="col-md-2">
                    <label for="queryUploadUsername">上传者用户名</label>
                    <input id="queryUploadUsername" type="text" class="form-control"

                           placeholder="上传者用户名">
                </div>
                <div class="col-md-1"  style="vertical-align: text-bottom">
                    <button class="btn query-file" id="query-user" style="margin-top: 25px;">查找文件</button>
                </div>
            </div><br/>
            <div class="row">
                <div class="col-md-10"></div>
                <button class="btn btn-success" data-toggle="modal" data-target="#insertFileModal"
                        style="margin-left: 65px;">上传文件</button>
            </div>
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                    <tr>
                        <th style="width: 100px">id</th>
                        <th style="width: 350px">文件名</th>
                        <th style="width: 150px">上传者</th>
                        <th style="width: 200px">上传时间</th>
                        <th>操作</th>
                    </tr>
                    </thead>
                    <tbody id="tbd">
                    </tbody>
                </table>
            </div>
            <div class="row" style="display: none" id="noAnyData">
                <div class="alert alert-warning" role="alert">
                    <div class="text-center">
                        <strong><h2>Warning!</h2></strong>
                        <h1>没有找到任何文件！</h1>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-4 center-block">
                    <div class="col-md-6"></div>
                    <div class="col-md-6">
                        <button class="btn btn-block" id="lastpage" style="display: none">上一页</button>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="text-center">
                        <input type="text" id="pageNow" name="custompage" class="px" size="1"
                               title="输入页码，按回车快速跳转" value="2" oninput="value=value.replace(/[^\d]/g,'')"
                               onkeydown="if(event.keyCode===13) {pageTurn()}">
                        <span id="showCount"> / <lable id="pageCount"></lable> 页</span>
                    </div>
                </div>
                <div class="col-md-4 text-center">
                    <div class="col-md-6">
                        <button class="btn btn-block" id="nextpage" style="display: block">下一页</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 模态框（Modal） -->
<div class="modal fade" id="insertFileModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
     aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="uploadForm" method="post" enctype="multipart/form-data">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                        &times;
                    </button>
                    <h4 class="modal-title">
                        选择文件
                    </h4>
                </div>
                <div class="modal-body">
                    <label class="control-label btn btn-primary"
                           for="uploadform-excelfiles">选择文件</label>
                    <input type="file" id="uploadform-excelfiles" name="uploadFiles"
                           multiple class="attachment-upload" style="display: none">
                    <!--另一个模态框无法打开的问题在这一行-->
                    <div class="form-group  field-uploadform-excelfiles" style="margin-left: 30px;">
                        <table role="presentation" class="table">
                            <tbody id="files"></tbody>
                        </table>
                        <div class="help-block"></div>
                        <div id="fileName"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <div class="row">
                        <!--进度条-->
                        <div class="col-md-12">
                            <div class="progress active">
                                <div class="progress-bar progress-bar-striped progress-bar-success"
                                     role="progressbar" aria-valuenow="60" id="uploadProgress"
                                     aria-valuemin="0" aria-valuemax="100" style="width: 0%">
                                    <span class="sr-only">60% Complete</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <button type="button" class="btn btn-default" data-dismiss="modal">关闭
                    </button>
                    <button type="button" id="fileUpload" class="btn btn-primary upload-file">
                        上传
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="updateFileModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
     aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                    &times;
                </button>
                <h4 class="modal-title">
                    修改文件
                </h4>
            </div>
            <div class="modal-body">
                <table>
                    <tr>
                        <td>Id：</td>
                        <td>
                            <div class="input-group">
                                <input id="updateFileId" readonly="readonly" type="text" class="form-control"
                                       placeholder="FileId">
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td>文件名：</td>
                        <td>
                            <div class="input-group">
                                <input id="updateFilename" type="text" class="form-control" placeholder="Filename">
                            </div>
                        </td>
                    </tr>
                </table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">关闭
                </button>
                <button type="button" class="btn btn-primary update-file">
                    提交更改
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap core JavaScript
================================================== -->
<!-- Placed at the end of the document so the pages load faster -->
<script src="https://cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"
        integrity="sha384-nvAa0+6Qg9clwYCGGPpDQLVpLNn0fRaROjHqs13t4Ggj3Ez50XnGQqc/r8MhnRDZ"
        crossorigin="anonymous"></script>
<script>window.jQuery || document.write('<script src="https://cdn.jsdelivr.net/npm/@bootcss/v3.bootcss.com@1.0.10/assets/js/vendor/jquery.min.js"><\/script>')</script>
<script src="https://cdn.jsdelivr.net/npm/@bootcss/v3.bootcss.com@1.0.10/dist/js/bootstrap.min.js"></script>
<!-- Just to make our placeholder images work. Don't actually copy the next line! -->
<script src="https://cdn.jsdelivr.net/npm/@bootcss/v3.bootcss.com@1.0.10/assets/js/vendor/holder.min.js"></script>
<!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
<script src="https://cdn.jsdelivr.net/npm/@bootcss/v3.bootcss.com@1.0.10/assets/js/ie10-viewport-bug-workaround.js"></script>
<!--页面加载时获取列表-->
<script type="text/javascript">
    <!--域名设置-->
    const DOMAIN = "localhost:8080";
    let pageNo = 1;
    let queryFileID = null;
    let queryFilename = null;
    let queryUploadUserId = null;
    let queryUploadUsername = null;
    let pageCount = "unknown";

    function getMyName() {
        $.ajax({
            url: "http://" + DOMAIN + "/FileManagementSystem/Login/getMyName",
            data: {},
            type: "GET",
            dataType: "text",
            //回调函数
            success: function (data) {
                if (data == null) {
                    $.ajax({
                        url: "http://" + DOMAIN + "/FileManagementSystem/Login/logout",
                        data: {},
                        type: "GET",
                        dataType: "text"
                    })
                } else {
                    $("#username")[0].innerHTML = data;
                }
            }
        });
    }

    function showData(data){
        $("#showCount")[0].title = "共" + pageCount + "页";
        $("#pageNow").val(pageNo);
        $("#pageCount")[0].innerHTML=pageCount;
        const savedFileList = data;
        if (pageNo===pageCount) {
            $("#nextpage")[0].style.display = 'none';
        } else {
            $("#nextpage")[0].style.display = 'block';
        }
        if(savedFileList.length === 0 && pageNo===1){
            $("#noAnyData")[0].style.display='block';
        }else {
            $("#noAnyData")[0].style.display='none';
        }
        for (let i = 0; i < savedFileList.length; i++) {
            var $fileElement = $('<tr></tr>');
            $fileElement.append('<td style="max-width: 100px">' + savedFileList[i].id + '</td>')
                .append('<td style="max-width: 350px">' + savedFileList[i].realFileName + '</td>')
                .append('<td style="max-width: 150px">' + savedFileList[i].uploader.username + '</td>')
                .append('<td style="max-width: 200px">' + savedFileList[i].uploadTime + '</td>')
                .append('<td><div style="display: inline-block"><button class="btn btn-info download-file" style="margin-right: 40px;">下载</button>' +
                    '<button class="btn btn-primary to-update-file"  data-toggle="modal" data-target="#updateFileModal">修改</button> ' +
                    '<button class="btn btn-danger delete-file">删除</button></div></td>');
            $('#tbd').append($fileElement);
        }
        $('.to-update-file').bind('click', function () {
            var id = $(this).parents('tr').children('td')[0].innerHTML;
            var filename = $(this).parents('tr').children('td')[1].innerHTML;
            $('#updateFileId').val(id);
            $('#updateFilename').val(filename);
        });

        $('.delete-file').bind('click', function () {
            var id = $(this).parents('tr').children('td')[0].innerHTML;
            var filename = $(this).parents('tr').children('td')[1].innerHTML;
            var flag = confirm('是否确认删除ID为' + id + '的文件?（文件名为：《' + filename + "》）");
            if (flag) {
                $.ajax({
                    url: "http://" + DOMAIN + "/FileManagementSystem/FileManagement/delete",
                    data: {id: id},
                    type: "GET",
                    dataType: "text",
                    success: function (data) {
                        if (data === "1") {
                            alert("删除成功");
                            location.reload();
                        } else {
                            alert("删除失败");
                        }
                    }
                })
            }
        });
        $('.download-file').bind('click', function () {
            var idText = $(this).parents('tr').children('td')[0].innerHTML;
            window.location.href = "http://" + DOMAIN + "/FileManagementSystem/FileManagement/downLoad?id=" + idText;
        })
    }

    function getData() {
        if (pageNo === 1) {
            $("#lastpage")[0].style.display = 'none';
        } else {
            $("#lastpage")[0].style.display = 'block';
        }
        //调用jQuery的ajax方法
        $.ajax({
            url: "http://" + DOMAIN + "/FileManagementSystem/FileManagement/queryByPage",
            data: {pageNo: pageNo},
            type: "GET",
            dataType: "text",
            //回调函数
            success: function (data) {
                data=JSON.parse(data);
                pageCount=data.count;
                showData(data.savedFileList);
            }
        });
    }

    function getDataForCondition(){
        if (pageNo === 1) {
            $("#lastpage")[0].style.display = 'none';
        } else {
            $("#lastpage")[0].style.display = 'block';
        }
        $.ajax({
            url: "http://" + DOMAIN + "/FileManagementSystem/FileManagement/queryByPageForCondition",
            data: {
                id: queryFileID,
                filename: queryFilename,
                uploadUserId: queryUploadUserId,
                uploadUsername:queryUploadUsername,
                pageNo: pageNo
            },
            type: "GET",
            dataType: "text",
            success: function (data) {
                data=JSON.parse(data);
                pageCount=data.count;
                showData(data.savedFileList);
            }
        });
    }


    function pageTurn(){
        var pageTo=$("#pageNow").val()
        if(pageTo>pageCount || pageTo <= 0){
            alert("页码超出范围");
            return;
        }
        pageNo=pageTo;
        $('#tbd')[0].innerHTML = null;
        if (queryFileID == null && queryEmail == null && queryUsername == null) {
            getData();
        } else {
            getDataForCondition();
        }
    }

    $(function () {
        getMyName();
        //页面DOM元素一加载完毕 就调用该方法
        getData();
        //当“上一页”的按钮被点击时
        $('#lastpage').bind('click', function () {
            pageNo--;
            $('#tbd')[0].innerHTML = null;
            if(queryFileID==null&&queryFilename==null&&queryUploadUserId==null&&queryUploadUsername==null){
                getData();
            }else{
                getDataForCondition();
            }
        });
        //当“下一页”的按钮被点击时
        $('#nextpage').bind('click', function () {
            pageNo++;
            $('#tbd')[0].innerHTML = null;
            if(queryFileID==null&&queryFilename==null&&queryUploadUserId==null&&queryUploadUsername==null){
                getData();
            }else{
                getDataForCondition();
            }
        });
        $('.update-file').bind('click', function () {
            var idText = $('#updateFileId').val();
            var filenameText = $('#updateFilename').val();
            if (filenameText === "") {
                alert("文件名不能位空！");
                return;
            }
            $.ajax({
                url: "http://" + DOMAIN + "/FileManagementSystem/FileManagement/update",
                data: {id: idText, realname: filenameText},
                type: "GET",
                dataType: "text",
                success: function (data) {
                    if (data > 0) {
                        alert("修改成功");
                        location.reload();
                    } else {
                        alert("修改失败");
                    }
                }
            })
        });
        $('.query-file').bind('click', function () {
            queryFileID=$('#queryFileId').val();
            queryFilename=$('#queryFilename').val();
            queryUploadUserId=$('#queryUploadUserID').val()
            queryUploadUsername=$('#queryUploadUsername').val();
            pageNo=1;
            $('#tbd')[0].innerHTML = null;
            getDataForCondition();
        });
    });
</script>

<!--上传文件-->
<script type="text/javascript">
    //获取change事件改变的文件
    var fileList;
    var allFile = [];
    //FormData对象初始化
    var form = document.getElementById("uploadForm");
    var formData = new FormData(form);
    $("#uploadform-excelfiles").on('change', function (e) {
        //获取表单数据并传入formData中
        var norm = $("#norm").val();
        var major = $("#major").val();
        var type = $("#type").val();
        formData.set("norm", norm);
        formData.set("major", major);
        formData.set("type", type);

        fileList = e.currentTarget.files;
        $.each(fileList, function (index, item) {
            var fileName = item.name;


            allFile.push(item);
            $('#files').append('<tr style="padding-top: 7px;">' +
                '<td>' + fileName + '</td>' +
                '<td>' + (item.size / 1024).toFixed(2) + 'K</td>' +
                '<td><input type="button" class="btn btn-danger delete" value="删除"></td>' +
                '</tr>');
            //追加文件
            formData.append('uploadFiles', item);

        });

        var fileCount = $('#files').find('tr').length;
        $('#fileName').html('共上传 ' + fileCount + ' 个文件');

    });

    //删除按钮事件
    $('#files').on('click', '.delete', function (e) {
        var saveFile = [];
        var norm = $("#norm").val();
        var major = $("#major").val();
        var type = $("#type").val();
        var deleteName = e.target.parentNode.previousElementSibling.previousElementSibling.textContent;
        var deleteIndex;
        //将不删除的放入数组中
        $.each(allFile, function (index, item) {
            if (item.name === deleteName) {
                deleteIndex = index;
            } else {
                saveFile.push(item);
            }
        });
        allFile.splice(deleteIndex, 1);
        //表单数据重置
        formData.set("norm", norm);
        formData.set("major", major);
        formData.set("type", type);
        formData.delete('uploadFiles');
        //将不删除的数组追加的formData中
        $.each(saveFile, function (index, item) {
            formData.append('uploadFiles', item);
        });

        e.target.parentNode.parentNode.remove();
        var fileCount = $('#files').find('tr').length;
        $('#fileName').html('共上传 ' + fileCount + ' 个文件');

    });

    //文件上传事件
    $("#fileUpload").on('click', function () {
        var len = formData.getAll('uploadFiles').length;
        $("#overlay").show();
        if (len > 1) {
            //通过ajax进行上传
            $.ajax({
                url: '../FileManagement/saveFile',
                type: 'POST',
                cache: false,
                data: formData,
                processData: false,
                contentType: false,
                success: function (errorList) {
                    if (errorList.length === 0) {
                        //如果没有上传错误的文件
                        var value = 0;
                        var timer2 = setInterval(function () {
                            value++;
                            $("#uploadProgress").css('width', value + "%");
                            if (value === 120) {
                                clearInterval(timer2);
                                $("#overlay").hide();
                                alert("文件上传成功!");
                                location.reload();
                            }
                        }, 50);
                    } else {
                        var message;
                        for (let i = 0; i < errorList.length; i++) {
                            message = "" + i + "." + errorList[i].realFileName + "\n";
                        }
                        alert("部分文件上传失败:\n" + message);
                    }
                }
            });
        } else {
            alert("请选择需要上传的文件！");
        }
    });
</script>
</body>
</html>
